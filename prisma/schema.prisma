// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String?
  password          String
  role              UserRole @default(TIME_SEEKER)
  avatar            String?
  bio               String?
  emotionalTempo    String?  // fast/slow
  silenceComfort    Int?     // 1-10 scale
  energyLevel       String?  // calm/neutral
  voiceTonePreference String? // deep/medium/high
  isAvailable       Boolean  @default(false)
  hourlyRate        Int?     // in rupees
  presenceRating    Float?   // average rating
  totalSessions     Int      @default(0)
  walletBalance     Float    @default(0) // in rupees
  totalEarnings     Float    @default(0) // total earned for time givers
  razorpayAccountId String?  // for time givers
  phone            String?  // for payments
  // Location fields
  latitude          Float?
  longitude         Float?
  city             String?
  state            String?
  country          String?
  timezone          String?
  maxDistance       Int?     // maximum distance for matching (in km)
  isLocationPublic  Boolean  @default(true) // show location on map
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  sessionsAsSeeker  Session[] @relation("SeekerSessions")
  sessionsAsGiver   Session[] @relation("GiverSessions")
  presenceRatings   PresenceRating[]
  availabilities    Availability[]
  transactions      Transaction[]
  wallets           Wallet[]
  paymentMethods     PaymentMethod[]

  @@map("users")
}

model Session {
  id              String        @id @default(cuid())
  seekerId        String
  giverId         String
  sessionType     SessionType
  duration        Int           // minutes
  status          SessionStatus @default(SCHEDULED)
  scheduledFor    DateTime
  startedAt       DateTime?
  endedAt         DateTime?
  meetingLink     String?
  notes           String?
  paymentStatus    PaymentStatus @default(PENDING)
  paymentId       String?       // Razorpay payment ID
  amount          Int           // in rupees
  platformFee     Int           @default(0) // platform commission
  giverEarnings   Int           @default(0) // what giver receives
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  seeker          User          @relation("SeekerSessions", fields: [seekerId], references: [id], onDelete: Cascade)
  giver           User          @relation("GiverSessions", fields: [giverId], references: [id], onDelete: Cascade)
  presenceRatings PresenceRating[]
  transactions     Transaction[]

  @@map("sessions")
}

model PresenceRating {
  id                String   @id @default(cuid())
  sessionId         String
  rating            Float    // 1-5 scale
  feltLessAlone     Boolean
  timeFeltHeavy     Boolean  // true = heavy, false = light
  wouldSitAgain     Boolean
  feedback          String?
  createdAt         DateTime @default(now())

  // Relations
  session           Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String

  @@map("presence_ratings")
}

model Availability {
  id          String   @id @default(cuid())
  userId      String
  dayOfWeek   Int      // 0-6 (Sunday-Saturday)
  startTime   String   // HH:MM format
  endTime     String   // HH:MM format
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("availabilities")
}

enum UserRole {
  TIME_SEEKER
  TIME_GIVER
  BOTH
}

enum SessionType {
  SILENT_PRESENCE
  OPEN_TALK
  MIRROR_MODE
  THINKING_ROOM
  FOCUS_COMPANION
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Transaction {
  id              String              @id @default(cuid())
  userId          String
  sessionId       String?
  type            TransactionType
  amount          Float               // in rupees
  status          TransactionStatus    @default(PENDING)
  paymentMethod   String?
  paymentId       String?             // Razorpay payment ID
  description     String?
  metadata        Json?               // additional payment data
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         Session?            @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@map("transactions")
}

model Wallet {
  id              String        @id @default(cuid())
  userId          String        @unique
  balance         Float         @default(0) // current balance
  totalEarned     Float         @default(0) // lifetime earnings
  totalWithdrawn  Float         @default(0) // total withdrawn
  lastUpdated     DateTime      @default(now())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model PaymentMethod {
  id              String            @id @default(cuid())
  userId          String
  type            PaymentMethodType
  provider        String            // razorpay, stripe, etc.
  providerId      String            // payment method ID from provider
  isDefault       Boolean           @default(false)
  metadata        Json?             // additional payment method data
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

enum TransactionType {
  SESSION_PAYMENT
  EARNINGS_CREDIT
  WITHDRAWAL
  REFUND
  PLATFORM_FEE
  BONUS_CREDIT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethodType {
  CREDIT_CARD
  DEBIT_CARD
  UPI
  NET_BANKING
  WALLET
}